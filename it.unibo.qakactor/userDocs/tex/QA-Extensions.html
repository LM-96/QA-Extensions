<h1 class="unnumbered" id="abstract">Abstract</h1>
<p>In this paper we discuss new mechanisms to define an executable
<em>actor model</em> using the custom infrastructure and modeling
language given by the course of <em>Ingegneria dei Sistemi Software</em>
of the Bologna university.</p>
<p>The main mechanism that we present is based on <a
href="https://docs.oracle.com/javase/tutorial/java/annotations/"><code>Java Annotations</code></a>.</p>
<h1 id="introduction">Introduction</h1>
<p><a
href="http://htmlpreview.github.io/?https://github.com/anatali/issLab2021/blob/main/it.unibo.qakactor/userDocs/LabQakIntro2021.html"><strong><em>QActor</em></strong></a>
(or <strong><em>QAK</em></strong>) is a modeling language to define meta
models using <em>actors</em>. The language is well explained in the
official <a
href="http://htmlpreview.github.io/?https://github.com/anatali/issLab2021/blob/main/it.unibo.qakactor/userDocs/LabQakIntro2021.html">web
page</a>.</p>
<p>The <em>QActor</em> does not only provide a custom <code>DSL</code>,
but also an entire infrastructure that let the developer to design and
build basic <em>actor</em> systems. Actually, there are two ways to
write systems based on actor modeling using <code>QAK</code>:</p>
<ol>
<li><p><em>the custom DSL</em> made using <a
href="https://www.eclipse.org/"><code>Eclipse</code></a> and <a
href="https://www.eclipse.org/Xtext/"><code>Xtext</code></a>;</p></li>
<li><p><em>manually</em>, writing the description of the system in a
<code>.pl</code> file and extending some classes of the infrastructure
like <a
href="https://htmlpreview.github.io/?https://github.com/anatali/issLab2021/blob/main/it.unibo.qakactor/userDocs/LabQakIntro2021.html#ActorBasic"><code>ActorBasic</code></a>
or <code>ActorBasicFsm</code>.</p></li>
</ol>
<p>Unfortunately, these two mechanisms have some problems:</p>
<ol>
<li><p>the DSL is strongly dependent from <code>Eclipse</code> because
it has not an own IDE. This can be a problem because the
<code>QAK</code> is written in <code>Kotlin</code> and
<code>Eclipse</code> is not fully compatible with this
language.</p></li>
<li><p>writing all things <em>manually</em> should be very
<em>uncomfortable</em>.</p></li>
</ol>
<p>So, in this report we analyze some alternatives to define the actor
model according with the <code>QAK</code> infrastructure. We will not go
into the details of the <code>QActor</code> implementations because they
are fully described into the official web page but we emphasize that the
main way to create an actor in this system is:</p>
<div class="center">
<p><strong>Creates a class</strong> that extends <code>ActorBasic</code>
or <code>ActorBasicFsm</code> with the body of the actor and <strong>add
a proper description</strong> of it into a file <code>.pl</code>. This
file must also contains all the information about the context of the
actor and the other actors that can be also remote.<a href="#fn1"
class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
</div>
<p>Indeed, the <code>DSL</code> does not do magic: it does nothing more
than auto-generate code that follows the mechanism that we have just
described. As we have already said, we want to extend this in order to
have a new mechanism based on <code>Java Annotation</code>.</p>
<p>But before doing this, we also want to find a way to strongly
<strong>separate the actor system description from its runtime
implementation</strong>. In fact, if we consider a single actor,
actually both of its description and its runtime context are enclosed
into the <code>ActorBasic</code> class (or <code>ActorBasicFsm</code>)
and its subclass that contains the body.</p>
<p>Then we want to provide a way to define <em>passive entities</em>
that only contain the description of the actor system you want to
define. As these entities will only be used to describe the system, we
will call them <strong><em>transient</em></strong>.</p>
<h1 id="the-transient-model">The Transient model</h1>
<h2 id="package-it.unibo.kaktor.model">Package
<code>it.unibo.kaktor.model</code></h2>
<p>As we have already said, the <em>transient</em> model consists in a
series of entities that represent the description of the actor system
that the application designer want to define. In a first approximation
these entities will then be wrapped into <code>ActorBasic</code>
instances that will be used as regular.</p>
<p>We remember that the main entities defined into the
<code>QA-System</code> are:</p>
<ul>
<li><p><strong>actors</strong> active components that are able to
receive messages and handle them in a proper way;</p></li>
<li><p><strong>body</strong> as the main behavior of each
actor;</p></li>
<li><p><strong>messages</strong> as the communication unit for the
actors;</p></li>
<li><p><strong>states</strong> (for finite state machine
actors);</p></li>
<li><p><strong>transitions</strong> (for finite state machine
actors);</p></li>
<li><p><strong>contexts</strong>;</p></li>
</ul>
<figure>
<img src="img/[UML]it.unibo.kaktor.model" id="fig::uml_model"
alt="UML diagram for the Transient Model" />
<figcaption aria-hidden="true">UML diagram for the Transient
Model</figcaption>
</figure>
<p>Slightly abusing the <code>UML</code> notation, the figure <a
href="#fig::uml_model" data-reference-type="ref"
data-reference="fig::uml_model">1</a> shows the diagram of the transient
model package. We have provided these classes:</p>
<ul>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/model/TransientActorBasic.kt"><u><strong><code>TransientActorBasic</code></strong></u></a>:<br />
The class represents the description of an actor (e.g. its name, its
scope, its channel size and other options), particularly <strong>its
body</strong> that will be described in a few lines; this is the central
class of the model that will be <em>wrapped</em> into the
<code>ActorBasic</code> class used from the system for the runtime
execution.</p></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/model/TransientActorBasicFsm.kt"><u><strong><code>TransientActorBasicFsm</code></strong></u></a>:<br />
This class represents the description of an actor that is a <em>finite
state machine</em>. So it extends the <code>TransientActorBasic</code>
class but has a <em>finite state body</em> instead of the normal body of
its super-class.</p></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/model/TransientState.kt"><u><strong><code>TransientState</code></strong></u></a>:<br />
This class represents the description of a state of a finite state
machine actor. It has a <em>name</em> and a <em>state body</em> that
will be called when a <em>FSM</em> actor enters the state.</p></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/model/TransitentTransition.kt"><u><strong><code>TransientTransition</code></strong></u></a>:<br />
This class represents the description of a transition from one state to
another into a <em>FSM</em> actor. So it has an <em>edge name</em> used
to identify uniquely the transition, a <em>target state</em> and a
<em>type</em>. Based on the type it also has additional fields used be
the specific type.</p></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/model/TransientContext.kt"><u><strong><code>TransientContext</code></strong></u></a>:<br />
This class represents the description of a context that contains a
collection of actors. In addition to this, a context also have some
field that describes some of its characteristics (like its name, its
address and so on).</p></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/model/TransientSystem.kt"><u><strong><code>TransientSystem</code></strong></u></a>:<br />
This class represents the description of the entire system that will be
executed. As a <code>TransientContext</code> it also has a
<code>ImmutableParameterMap</code> that is an object defined in another
package that maintains a series of key-object pairs for re-usability.
<strong>This is the end class of the <em>transient model</em> that will
be passed to method that load and build the entire
system</strong>.</p></li>
</ul>
<h2 id="package-it.unibo.kaktor.model.actorbody">Package
<code>it.unibo.kaktor.model.actorbody</code></h2>
<p>We have shown that the <code>TransientActorBasic</code> class
maintains an object that represents the actor body. Same for the
<code>TransientActorBasicFsm</code> class in which the difference is
that the body has the behavior of a finite state machine.</p>
<figure>
<img src="img/[UML]it.unibo.kaktor.model.actorbody_onlyactorbody"
id="fig::uml_model_body"
alt="UML diagram for the Transient Model of the actor body" />
<figcaption aria-hidden="true">UML diagram for the Transient Model of
the actor body</figcaption>
</figure>
<p>The figure <a href="#fig::uml_model_body" data-reference-type="ref"
data-reference="fig::uml_model_body">2</a> summarizes the package that
contains the classes for the actor body. The main classes of this
package are:</p>
<ul>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/model/actorbody/TransientActorBasicBody.kt"><u><strong><code>TransientActorBasicBody</code></strong></u></a>:<br />
This classes that implements this symbolic interface are actor basic
bodies.</p></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/model/actorbody/TransientLambdaActorBasicBody.kt"><u><strong><code>TransientLambdaActorBasicBody</code></strong></u></a>:<br />
This is the main class for a body of an <code>ActorBasic</code>
instance. It maintains a <a
href="https://kotlinlang.org/docs/lambdas.html"><em>lambda
function</em></a> that describes the actions the actor will have to
perform when receives a message.</p></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/model/actorbody/TransientActorBasicFsmBody.kt"><u><strong><code>TransientActorBasicFsmBody</code></strong></u></a>:<br />
This is the main class for a body of an <code>ActorBasicFsm</code>
instance. It maintains a <a
href="https://kotlinlang.org/docs/lambdas.html#closures"><em>lambda
function with closure</em></a> that contains the actions to be create an
instance of the <code>ActorBasicFsm</code> class<a href="#fn2"
class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> and
also the name of the initial state.</p></li>
</ul>
<p>The other classes of this package are useful in order to easily
create instances of these main superclasses and will be clarified
soon.</p>
<figure>
<img src="img/[UML]it.unibo.kaktor.model.actorbody_onlystatebody"
id="fig::uml_model_state_body"
alt="UML diagram for the Transient Model of the actor body" />
<figcaption aria-hidden="true">UML diagram for the Transient Model of
the actor body</figcaption>
</figure>
<p>The figure <a href="#fig::uml_model_state_body"
data-reference-type="ref"
data-reference="fig::uml_model_state_body">3</a> shows the classes
describing the body of a state. It contains:</p>
<ul>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/model/actorbody/TransientStateBody.kt"><u><strong><code>TransientStateBody</code></strong></u></a>:<br />
This classes that implements this symbolic interface are finite state
machines bodies.</p></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/model/actorbody/TransientLambdaStateBody.kt"><u><strong><code>TransientLambdaStateBody</code></strong></u></a>:<br />
This is the main class for a body of a finite state machine. It
maintains a <a
href="https://kotlinlang.org/docs/lambdas.html"><em>lambda
function</em></a> that describes the actions the actor will have to
perform when enters the state owning this body.</p></li>
</ul>
<p>The other two subclasses will be used to easily create instance of
lambda state body and will be clear when we present the
<code>QActorBasic</code> and <code>AutoQActorBasic</code> classes.</p>
<h1 id="the-builder-mechanism">The builder mechanism</h1>
<h2
id="overview-of-the-builder-package-it.unibo.kaktor.builders">Overview
of the builder package <code>it.unibo.kaktor.builders</code></h2>
<p>In addition to the transient model, we want to provide a sort of
<em>standard mechanism</em> that must be reliable and reusable to create
the transient entities.</p>
<p>So, we decided to use the <a
href="https://en.wikipedia.org/wiki/Builder_pattern">builder
pattern</a>.</p>
<figure>
<img src="img/[UML]it.unibo.kaktor.builders_actorb_contextb_systemb"
id="fig::builders_actorb_contextb_systemb" style="width:92.0%"
alt="UML diagram for the actor, context and system builders" />
<figcaption aria-hidden="true">UML diagram for the actor, context and
system builders</figcaption>
</figure>
<p>The figure <a href="#fig::builders_actorb_contextb_systemb"
data-reference-type="ref"
data-reference="fig::builders_actorb_contextb_systemb">4</a> shows the
main builder components for the transient system. They are:</p>
<ul>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/builders/ActorBasicBuilder.kt"><u><strong><code>ActorBasicBuilder</code></strong></u></a>:<br />
This component let to create a <code>TransientActorBasic</code> using
the builder pattern. It is easy possible to set the actor body by
calling the <code>addActorBoby(TransientActorBody)</code> method. There
are others additional methods that can be used to quickly add more
complex body that the normal lambda body (the classes not already
explained of the transient body model).</p></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/builders/ActorBasicFsmBuilder.kt"><u><strong><code>ActorBasiFsmcBuilder</code></strong></u></a>:<br />
This component let to create a <code>TransientActorBasicFsm</code> using
the builder pattern. This class extends the
<code>ActorBasicBuilder</code> then add others additional method to its
in order to create a finite state machine actor. It is easy possible to
add a state to the actor that is building by calling
<code>newState()</code> method that returns a <code>StateBuilder</code>
for the new state.</p></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/builders/ContextBuilder.kt"><u><strong><code>ContextBuilder</code></strong></u></a>:<br />
This component let to create a <code>TransientContext</code>. It is easy
possible to add an actor to the context that is building by calling
<code>newActorBasic()</code> or <code>newActorBasicFsm()</code> methods
that return a builder for the new actor.</p></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/builders/SystemBuilder.kt"><u><strong><code>SystemBuilder</code></strong></u></a>:<br />
This component let to create a <code>TransientSystem</code>. It is easy
possible to add a context to the system that is building by calling
<code>newContext()</code> method that returns a
<code>ContextBuilder</code>. When the creation of the transient system
is completed so it is needed to invoke the <code>build()</code> method
that returns the <code>TransientSystem</code>. Notice that <strong>a
<code>SystemBuilder</code> cannot be reused then once the system is
created it not possible to clear the builder and start again the
creation</strong>. In addition to this, after the build method
invocation, there are no possibilities to add other contexts or to build
again.</p></li>
</ul>
<p>In addition to all things we have just explained, the builders can
throw a <code>BuildException</code> if something goes wrong or if the
developer has not passed all the needed information to it before
invoking <code>build()</code>, for example if the developer invoke it
without calling the <code>addActorName(String)</code> before.</p>
<figure>
<img src="img/[UML]it.unibo.kaktor.builders_stateb_transitionb"
id="fig::builders_stateb_transitionb"
alt="UML diagram for the for the state and transition builders" />
<figcaption aria-hidden="true">UML diagram for the for the state and
transition builders</figcaption>
</figure>
<p>As anticipated, for finite state machine actors we also provide some
additional builders shown in the figure <a
href="#fig::builders_stateb_transitionb" data-reference-type="ref"
data-reference="fig::builders_stateb_transitionb">5</a>:</p>
<ul>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/builders/StateBuilder.kt"><u><strong><code>StateBuilder</code></strong></u></a>:<br />
The component for building states. If we have an
<code>ActorBasicFsmBuilder</code> we can call the
<code>newState()</code> method that returns an instance of the
<code>StateBuilder</code> class that can be used to add states. When all
of the states are added then it is possible to invoke the
<code>buildState()</code> method that return the original actor builder.
<strong>Notice that it not possible to create a
<code>StateBuilder</code> because it can only be obtained from an actor
builder</strong>.</p></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/builders/TransitionBuilder.kt"><u><strong><code>TransitionBuilder</code></strong></u></a>:<br />
The component for building transitions. It can be obtained using the
<code>newTransition()</code> method of the <code>StateBuilder</code>
class with the same mechanism by which the state builder can be obtained
from the actor builder. In addition, this component has more than one
<code>build</code> method for each type of transition supported by the
infrastructure.</p></li>
</ul>
<h2 id="the-wrappers">The wrappers</h2>
<p>As we have already said, the transient entities of the model are only
a <strong>passive description</strong> of the system that will have to
run. So this description must be transformed into the <strong>executable
units</strong> that are present in the <code>QA</code> infrastructure:
<code>ActorBasic</code> and <code>ActorBasicFsm</code>.</p>
<figure>
<img src="img/[UML]it.unibo.kaktor.builders_wrapper"
id="fig::builders_wrapper" alt="UML diagram for the wrappers" />
<figcaption aria-hidden="true">UML diagram for the wrappers</figcaption>
</figure>
<p>The <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/builders/Wrappers.kt"><code>Wrappers.kt</code></a>
file contains the classes to <strong>wrap</strong> the
<code>TransientActorBasic</code> and the
<code>TransientActorBasicFsm</code> entities into the active entities of
the <code>QA-System</code>. This file also contains some extensions
method for the <code>TransientActorBasic</code> class to quickly wrap it
into an <code>ActorBasic</code> instance.</p>
<p>For the details about wrappers and their work, please see <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/builders/Wrappers.kt">the
source code</a>.</p>
<h2 id="example-of-system-creation-using-builders">Example of system
creation using builders</h2>
<p>Suppose to have a system with a context that contains an actor called
<em>echoactor</em> with this behavior:</p>
<figure>
<embed src="img/[EG]simple_echo_actor_diagram.pdf"
id="fig::echo_actor_example" />
<figcaption aria-hidden="true">Behavior of the
<em>echoactor</em></figcaption>
</figure>
<p>This simple actor is able to handle a request called
<code>echorequest</code> by answering with an <code>echoresponse</code>
reply containing the same contents of the request. Then, in order to
define the system using the builders, the procedure is:</p>
<div class="sourceCode" id="lst::echoexample"
data-caption="Example of builders use" label="lst::echoexample"
data-language="kotlin"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="lst::echoexample-1"><a href="#lst::echoexample-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* BODIES OF THE STATES FOR echoactor ***************************** */</span></span>
<span id="lst::echoexample-2"><a href="#lst::echoexample-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">s0Body</span> <span class="op">:</span> suspend QActorBasicFsm<span class="op">.()-&gt;</span> <span class="kw">Unit</span> <span class="op">=</span></span>
<span id="lst::echoexample-3"><a href="#lst::echoexample-3" aria-hidden="true" tabindex="-1"></a>	<span class="op">{</span> println<span class="op">(</span><span class="st">&quot;started&quot;</span><span class="op">)</span> <span class="op">}</span></span>
<span id="lst::echoexample-4"><a href="#lst::echoexample-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">workBody</span> <span class="op">:</span> suspend QActorBasicFsm<span class="op">.()</span> <span class="op">-&gt;</span> <span class="kw">Unit</span> <span class="op">=</span></span>
<span id="lst::echoexample-5"><a href="#lst::echoexample-5" aria-hidden="true" tabindex="-1"></a>	<span class="op">{</span> println<span class="op">(</span><span class="st">&quot;idle&quot;</span><span class="op">)</span> <span class="op">}</span></span>
<span id="lst::echoexample-6"><a href="#lst::echoexample-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">handleRequestBody</span> <span class="op">:</span> suspend QActorBasicFsm<span class="op">.()</span> <span class="op">-&gt;</span> <span class="kw">Unit</span> <span class="op">=</span></span>
<span id="lst::echoexample-7"><a href="#lst::echoexample-7" aria-hidden="true" tabindex="-1"></a>	<span class="op">{</span> answer<span class="op">(</span><span class="st">&quot;echorequest&quot;</span><span class="op">,</span> <span class="st">&quot;echoreply&quot;</span><span class="op">,</span> currentMsg<span class="op">.</span>msgContent<span class="op">())</span> <span class="op">}</span></span>
<span id="lst::echoexample-8"><a href="#lst::echoexample-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst::echoexample-9"><a href="#lst::echoexample-9" aria-hidden="true" tabindex="-1"></a><span class="co">/* SYSTEM BUILDER ************************************************* */</span></span>
<span id="lst::echoexample-10"><a href="#lst::echoexample-10" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">sysBuilder</span> <span class="op">=</span> SystemBuilder<span class="op">()</span></span>
<span id="lst::echoexample-11"><a href="#lst::echoexample-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst::echoexample-12"><a href="#lst::echoexample-12" aria-hidden="true" tabindex="-1"></a><span class="co">/* SYSTEM CREATION ************************************************ */</span></span>
<span id="lst::echoexample-13"><a href="#lst::echoexample-13" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">system</span> <span class="op">=</span> runBlocking <span class="op">{</span></span>
<span id="lst::echoexample-14"><a href="#lst::echoexample-14" aria-hidden="true" tabindex="-1"></a>	sysBuilder<span class="op">.</span>addHostname<span class="op">(</span><span class="st">&quot;localhost&quot;</span><span class="op">).</span>addScope<span class="op">(</span><span class="kw">this</span><span class="op">)</span></span>
<span id="lst::echoexample-15"><a href="#lst::echoexample-15" aria-hidden="true" tabindex="-1"></a>	<span class="co">//Context: &quot;ctxecho&quot;</span></span>
<span id="lst::echoexample-16"><a href="#lst::echoexample-16" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>newContext<span class="op">()</span></span>
<span id="lst::echoexample-17"><a href="#lst::echoexample-17" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>addContextName<span class="op">(</span><span class="st">&quot;ctxecho&quot;</span><span class="op">)</span></span>
<span id="lst::echoexample-18"><a href="#lst::echoexample-18" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>addContextAddress<span class="op">(</span><span class="st">&quot;localhost&quot;</span><span class="op">).</span>addContextPort<span class="op">(</span><span class="dv">9000</span><span class="op">)</span></span>
<span id="lst::echoexample-19"><a href="#lst::echoexample-19" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>addContextProtocol<span class="op">(</span><span class="st">&quot;TCP&quot;</span><span class="op">)</span></span>
<span id="lst::echoexample-20"><a href="#lst::echoexample-20" aria-hidden="true" tabindex="-1"></a>	<span class="co">//Actor: &quot;echoactor&quot;</span></span>
<span id="lst::echoexample-21"><a href="#lst::echoexample-21" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>newActorBasic<span class="op">().</span>addActorName<span class="op">(</span><span class="st">&quot;echoactor&quot;</span><span class="op">)</span></span>
<span id="lst::echoexample-22"><a href="#lst::echoexample-22" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>upgrateToFsmBuilder<span class="op">().</span>addQActorBasicFsm<span class="op">(</span>QActorBasicFsm<span class="op">())</span></span>
<span id="lst::echoexample-23"><a href="#lst::echoexample-23" aria-hidden="true" tabindex="-1"></a>				<span class="co">//State: &quot;s0&quot;</span></span>
<span id="lst::echoexample-24"><a href="#lst::echoexample-24" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>newState<span class="op">().</span>addStateName<span class="op">(</span><span class="st">&quot;s0&quot;</span><span class="op">).</span>addStateBody<span class="op">(</span>s0Body<span class="op">)</span></span>
<span id="lst::echoexample-25"><a href="#lst::echoexample-25" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>newTransition<span class="op">()</span></span>
<span id="lst::echoexample-26"><a href="#lst::echoexample-26" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>addEdgeName<span class="op">(</span><span class="st">&quot;t0&quot;</span><span class="op">).</span>addTargetState<span class="op">(</span><span class="st">&quot;work&quot;</span><span class="op">)</span></span>
<span id="lst::echoexample-27"><a href="#lst::echoexample-27" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>buildEpsilonMove<span class="op">().</span>buildState<span class="op">()</span></span>
<span id="lst::echoexample-28"><a href="#lst::echoexample-28" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>setInitialState<span class="op">(</span><span class="st">&quot;s0&quot;</span><span class="op">)</span></span>
<span id="lst::echoexample-29"><a href="#lst::echoexample-29" aria-hidden="true" tabindex="-1"></a>				<span class="co">//State: &quot;work&quot;</span></span>
<span id="lst::echoexample-30"><a href="#lst::echoexample-30" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>newState<span class="op">().</span>addStateName<span class="op">(</span><span class="st">&quot;work&quot;</span><span class="op">).</span>addStateBody<span class="op">(</span>workBody<span class="op">)</span></span>
<span id="lst::echoexample-31"><a href="#lst::echoexample-31" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>newTransition<span class="op">()</span></span>
<span id="lst::echoexample-32"><a href="#lst::echoexample-32" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>addEdgeName<span class="op">(</span><span class="st">&quot;t1&quot;</span><span class="op">).</span>addTargetState<span class="op">(</span><span class="st">&quot;handleRequest&quot;</span><span class="op">)</span></span>
<span id="lst::echoexample-33"><a href="#lst::echoexample-33" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>buildWhenRequest<span class="op">(</span><span class="st">&quot;echorequest&quot;</span><span class="op">).</span>buildState<span class="op">()</span></span>
<span id="lst::echoexample-34"><a href="#lst::echoexample-34" aria-hidden="true" tabindex="-1"></a>				<span class="co">//State: &quot;handleRequest</span></span>
<span id="lst::echoexample-35"><a href="#lst::echoexample-35" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>newState<span class="op">().</span>addStateName<span class="op">(</span><span class="st">&quot;handleRequest&quot;</span><span class="op">)</span></span>
<span id="lst::echoexample-36"><a href="#lst::echoexample-36" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>addStateBody<span class="op">(</span>handleRequestBody<span class="op">)</span></span>
<span id="lst::echoexample-37"><a href="#lst::echoexample-37" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>newTransition<span class="op">()</span></span>
<span id="lst::echoexample-38"><a href="#lst::echoexample-38" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>addEdgeName<span class="op">(</span><span class="st">&quot;t2&quot;</span><span class="op">).</span>addTargetState<span class="op">(</span><span class="st">&quot;work&quot;</span><span class="op">).</span>buildEpsilonMove<span class="op">()</span></span>
<span id="lst::echoexample-39"><a href="#lst::echoexample-39" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>buildState<span class="op">()</span></span>
<span id="lst::echoexample-40"><a href="#lst::echoexample-40" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>buildInContext<span class="op">().</span>second<span class="op">.</span>buildInSystem<span class="op">().</span>second<span class="op">.</span>build<span class="op">()</span></span>
<span id="lst::echoexample-41"><a href="#lst::echoexample-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The <code>.kt</code> source code is available <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/demo/EchoExample.kt">here</a>.</p>
<p>At the end of the execution of this snippet, the <code>system</code>
variable contains the <code>OOP</code> description of the actor system
with the <code>echoactor</code> described in the figure <a
href="#fig::echo_actor_example" data-reference-type="ref"
data-reference="fig::echo_actor_example">7</a>.</p>
<p>The motivations for the line <span class="math inline">22</span>
(<code>addQActorBasicFsm(QActorBasicFsm())</code>) will be clarified
thanks to the introduction of <code>QActorBasic</code> class.</p>
<h2
id="the-last-step-for-builders-adding-support-for-make-transientsystem-runnable">The
last step for builders: adding support for make
<code>TransientSystem</code> runnable</h2>
<p>In the previous example we have created a complete description of the
system contained into the <code>system</code> variable. But what do we
do with this now? How we can run the <code>TransientSystem</code>?</p>
<p>In order to do it, <strong>we have to modify the launching methods of
the <code>QA-System</code></strong>. Without going into details, we have
created a new method into the <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/QakContext.kt"><code>QakContext.kt</code></a>
that has this signature:</p>
<div class="center">
<table>
<tbody>
<tr class="odd">
<td style="text-align: center;"><div class="sourceCode" id="cb1"
data-frame="none" data-numbers="none" data-language="Kotlin"><pre
class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">createSystem</span><span class="op">(</span><span class="va">transientSystem</span> <span class="op">:</span> <span class="dt">TransientSystem</span><span class="op">)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>		</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>This method <span style="color: BrickRed"><strong>creates and run the
system</strong></span> starting from a <code>TransientSystem</code>
instance. In addition to this, we have created lots of method into the
<a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/sysUtil.kt"><code>sysUtil.kt</code></a>
utility that helps the <code>createSystem()</code> to do its work such
as:</p>
<div class="center">
<table>
<tbody>
<tr class="odd">
<td style="text-align: center;"><div class="sourceCode" id="cb2"
data-frame="none" data-numbers="none" data-language="Kotlin"><pre
class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">createSystem</span><span class="op">(</span><span class="va">tSystem</span><span class="op">:</span> <span class="dt">TransientSystem</span><span class="op">,</span> <span class="va">start</span> <span class="op">:</span> <span class="dt">Boolean</span> <span class="op">=</span> true<span class="op">)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>			<span class="kw">fun</span> <span class="fu">createContext</span><span class="op">(</span><span class="va">tCtx</span> <span class="op">:</span> <span class="dt">TransientContext</span><span class="op">,</span> <span class="va">hostName</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">:</span> <span class="dt">QakContext</span><span class="op">?</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>			<span class="kw">fun</span> <span class="fu">addTheActors</span><span class="op">(</span><span class="va">ctx</span><span class="op">:</span> <span class="dt">TransientContext</span><span class="op">,</span> <span class="va">qakCtx</span> <span class="op">:</span> <span class="dt">QakContext</span> <span class="op">)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>		</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>which follows the methods that were used by the old mechanism.</p>
<p>In order to conclude the example of the listing <a
href="#lst::echoexample" data-reference-type="ref"
data-reference="lst::echoexample">[lst::echoexample]</a>, we must add
this line to run the system:</p>
<div class="sourceCode" id="cb3" data-language="Kotlin"><pre
class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>QakContext<span class="op">.</span>createSystem<span class="op">(</span>system<span class="op">)</span></span></code></pre></div>
<h1 id="annotations">Annotations</h1>
<p>All the source code of this section is available <a
href="https://github.com/LM-96/QA-Extensions/tree/main/it.unibo.qakactor/src/main/kotlin/annotations">here</a>.</p>
<h2 id="the-example-case-ledsonar-system">The example case:
<code>LedSonar</code> system</h2>
<p>Before talking about annotations, we show a small example that will
be used to demonstrate some usages and to make some first approximated
tests.</p>
<p>We will consider a simple case that is used in the course of
<em>Ingegneria Dei Sistemi Software</em>: a system with a <span
style="color: MidnightBlue"><strong>led</strong></span> and a <span
style="color: MidnightBlue"><strong>sonar</strong></span> connected to a
single board computer like Raspberry. <strong>When the sonar detects a
distance less than a threshold, the system must turn on the led. If the
distance detected goes over this threshold, the led must be powered
off</strong>.</p>
<figure>
<embed src="img/[EG]led_sonar_actor_diagram.pdf"
id="fig::ledsonar_system" />
<figcaption aria-hidden="true">Diagram of the <code>ledsonar</code>
system</figcaption>
</figure>
<p>The figure <a href="#fig::ledsonar_system" data-reference-type="ref"
data-reference="fig::ledsonar_system">8</a> shows the diagram of the
<code>ledsonar</code> system that will be used for the examples. The
legend of the used notation can be found <a
href="https://github.com/anatali/issLab2021/blob/main/it.unibo.issLabStart/userDocs/Legenda.pptx">here</a>,
but we will not go into the details of the logic.</p>
<p>In summary:</p>
<ul>
<li><p><u><code>SonarActor</code></u>:<br />
This actor holds a sonar that it can use to read the value from it. The
actor can receive request and answer to it, but it also do polling
emitting <code>sonarDistance</code> events with the current value of the
distance read from the sonar.</p></li>
<li><p><u><code>LedActor</code></u>:<br />
This actor holds a led that it can command. The actor can receive
dispatch <code>ledCmd(CMD)</code> with two possible value:
<code>ON</code> for power on the led and <code>OFF</code> for turn it
off.</p></li>
<li><p><u><code>DistanceActor</code></u>:<br />
This actor continuously monitors the distance emitted by the
<code>SonarActor</code>: if the value is less then the threshold then
emits a <code>distanceAlarm("CRITICAL")</code> event, otherwise if the
the distance returns to a value greater than the threshold then it fires
the event <code>distanceAlarm("NORMAL")</code>.</p></li>
<li><p><u><code>AppActor</code></u>:<br />
This actor realizes the business logic of the example system. When a
<code>distanceAlarm</code> event is detected then it command the led in
the proper way following the logic we have already shown.</p></li>
</ul>
<p>We also need a <em>virtual environment</em> in order to test our
example system. Then we have created a small <em>web based</em>
architecture that simulates a <em>sonar</em> and a <em>led</em> using
<code>WebSocket</code>. The source code of this small system made in
<code>Kotlin</code> using <a
href="https://ktor.io/"><code>Ktor</code></a> can be found <a
href="https://github.com/LM-96/QA-Extensions/tree/main/it.unibo.ledsonarsystem">here</a>.</p>
<figure>
<img src="img/[EG]led_sonar_actor_gui.png" id="fig::ledsonar_system_gui"
alt="Web GUI of the ledsonar system" />
<figcaption aria-hidden="true">Web GUI of the <code>ledsonar</code>
system</figcaption>
</figure>
<p>When this system is started it possible to go at <a
href="http://localhost:8000/index.html">localhost:8000/index.html</a> in
order to get a small web based GUI that is shown in the figure <a
href="#fig::ledsonar_system_gui" data-reference-type="ref"
data-reference="fig::ledsonar_system_gui">9</a>. The GUI use
<code>WebSocket</code> in order to send new distances when the slider of
the sonar is moved or to receive the command to power on/off the led. In
particular, the GUI offers:</p>
<ul>
<li><p>a <span style="color: ForestGreen"><strong>slider</strong></span>
to modify the distance read from the sonar;</p></li>
<li><p>a <span style="color: ForestGreen"><strong>box</strong></span> in
which to type the new value of the threshold that can be sent over the
WebSocket when the <code>Set</code> button is pressed;</p></li>
<li><p>a <span style="color: ForestGreen"><strong>led
image</strong></span> that shows when the led is powered on or
off.</p></li>
</ul>
<p>For this reason the actor system in the figure <a
href="#fig::ledsonar_system" data-reference-type="ref"
data-reference="fig::ledsonar_system">8</a> contains an additional actor
called <u><code>ThresholdActor</code></u>: it listens the commands to
update the threshold over the WebSocket and when a new value is received
emits the proper event <code>newTreshold</code>.</p>
<p>In order to start this system it possible to call the
<code>startLedSonarSystem()</code> function that is present in the file
<a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.ledsonarsystem/src/main/kotlin/it/unibo/ledsonarsystem/LedSonarSystem.kt">LedSonarSystem.kt</a>.</p>
<p>If you want to use a real sonar or a real led you only have to
extends properly the two <code>POJO</code> owned by the
<code>SonarActor</code> and the <code>LedActor</code>.</p>
<h2 id="descriptive-annotations-ledonarsystem0">Descriptive annotations
[ <a
href="https://github.com/LM-96/QA-Extensions/tree/main/it.unibo.ledsonardemo0"><span
style="color: Emerald"><strong>ledonarsystem0</strong></span></a> ]</h2>
<p>The focus of our discussion is <span
style="color: ForestGreen"><strong>to introduce a new mechanism that let
the developer able to easily describe the system using
annotations</strong></span>. The use of the annotation can be very
useful:</p>
<ul>
<li><p>they do not depend on an IDE and are included in Java so there
are no compatibility problems;</p></li>
<li><p>they can completely describe all the aspects of the actor
system;</p></li>
<li><p>the use of the annotations is very easy and intuitive.</p></li>
</ul>
<p>So the first step is <span style="color: ForestGreen"><strong>to
develop some annotations to eliminate the need for the <code>.pl</code>
file</strong></span>. This annotations let the system able to find all
the information about the contexts and the actors that are defined.</p>
<ul>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/annotations/QakContext.kt"><span
style="color: YellowOrange"><u><code>QakContext</code></u></span></a>:<br />
<em>This annotation is applicable to a class and give to the system the
information about a context (name, address, protocol and port).</em></p>
<div class="sourceCode" id="cb4" data-numbers="none"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>annotation <span class="kw">class</span> QakContext<span class="op">(</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">contextName</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">contextAddress</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">contextProtocol</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">contextPort</span> <span class="op">:</span> <span class="dt">Int</span><span class="op">,</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>		<span class="op">)</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>	</span></code></pre></div></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/annotations/QActor.kt"><span
style="color: YellowOrange"><u><code>QActor</code></u></span></a>:<br />
<em>This annotation is applicable to a class that is an actor and then
<strong>it must extends <code>ActorBasic</code></strong>. It maintains
all the information of the actor (name, context, ecc…)</em></p>
<div class="sourceCode" id="cb5" data-numbers="none"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>annotation <span class="kw">class</span> QActor<span class="op">(</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">contextName</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">actorName</span> <span class="op">:</span> <span class="dt">String</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">,</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">discardMessage</span> <span class="op">:</span> <span class="dt">Boolean</span> <span class="op">=</span> false<span class="op">,</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">confined</span> <span class="op">:</span> <span class="dt">Boolean</span> <span class="op">=</span>  false<span class="op">,</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">ioBound</span> <span class="op">:</span> <span class="dt">Boolean</span> <span class="op">=</span> false<span class="op">,</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">channelSize</span> <span class="op">:</span> <span class="dt">Int</span> <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>		<span class="op">)</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>	</span></code></pre></div></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/annotations/QakContext.kt"><span
style="color: YellowOrange"><u><code>Hostname</code></u></span></a>:<br />
<em>This annotation is applicable to a class and indicates the hostname
of the system. This annotation is not strictly necessary but at the
moment it’s mandatory to identify the context that have to run
locally.</em></p>
<div class="sourceCode" id="cb6" data-numbers="none"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>annotation <span class="kw">class</span> HostName<span class="op">(</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">hostname</span> <span class="op">:</span> <span class="dt">String</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>		<span class="op">)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>	</span></code></pre></div></li>
</ul>
<p>Actually, there is no full support to the description of remote
actors but in future development it is easy to add it.</p>
<p>Then, as explained the <em>location</em> of the entities of the
system can be describing using these annotations. The <a
href="https://github.com/LM-96/QA-Extensions/tree/main/it.unibo.ledsonardemo0"><span
style="color: Emerald"><strong>ledonarsystem0</strong></span></a>
example shows how it is possible to use them. In this paper we just show
the <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.ledsonardemo0/src/main/kotlin/it/unibo/ledsonardemo0/actors/SonarActor.kt">SonarActor</a>
and the <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.ledsonardemo0/src/main/kotlin/it/unibo/ledsonardemo0/actors/LedActor.kt">LedActor</a>:</p>
<div class="sourceCode" id="cb7"
data-caption="\texttt{SonarActor} (\texttt{ledsonarsystem0})"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="at">@QActor</span><span class="op">(</span><span class="st">&quot;ctxLedSonarAbFsmDemo&quot;</span><span class="op">)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SonarActor<span class="op">(</span><span class="va">name</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">scope</span> <span class="op">:</span> <span class="dt">CoroutineScope</span><span class="op">)</span> <span class="op">:</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>	<span class="dt">ActorBasicFsm</span><span class="op">(</span><span class="va">name</span><span class="op">,</span> <span class="va">scope</span><span class="op">,</span> <span class="va">autoStart</span> <span class="op">=</span> false<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>	</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>	<span class="kw">var</span> <span class="va">distance</span> <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>	<span class="kw">var</span> <span class="va">prevDistance</span> <span class="op">=</span> distance</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>	<span class="kw">val</span> <span class="va">sonar</span> <span class="op">=</span> SYSTEM_SONAR</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>	</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>	<span class="kw">override</span> <span class="kw">fun</span> <span class="fu">getBody</span><span class="op">():</span> <span class="dt">ActorBasicFsm</span><span class="op">.()</span> -&gt; <span class="fu">Unit</span> <span class="op">{</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>		<span class="kw">return</span> <span class="op">{</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>			state<span class="op">(</span><span class="st">&quot;begin&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>				transition<span class="op">(</span>edgeName <span class="op">=</span> <span class="st">&quot;t0&quot;</span><span class="op">,</span> targetState <span class="op">=</span> <span class="st">&quot;work&quot;</span><span class="op">,</span> cond <span class="op">=</span> doswitch<span class="op">())</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>			<span class="op">}</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>			</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>			state<span class="op">(</span><span class="st">&quot;work&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>				action <span class="op">{</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>					stateTimer <span class="op">=</span> TimerActor<span class="op">(</span><span class="st">&quot;timer_begin&quot;</span><span class="op">,</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>					scope<span class="op">,</span> context<span class="op">!!,</span> <span class="st">&quot;local_tout_</span><span class="ss">${</span>name<span class="ss">}</span><span class="st">_</span><span class="ss">$stateName</span><span class="st">&quot;</span><span class="op">,</span> <span class="dv">2000</span> <span class="op">)</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>				<span class="op">}</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>				transition<span class="op">(</span>edgeName <span class="op">=</span> <span class="st">&quot;t1&quot;</span><span class="op">,</span> targetState <span class="op">=</span> <span class="st">&quot;readSonar&quot;</span><span class="op">,</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>				cond <span class="op">=</span> whenTimeout<span class="op">(</span><span class="st">&quot;local_tout_</span><span class="ss">${</span>name<span class="ss">}</span><span class="st">_</span><span class="ss">$stateName</span><span class="st">&quot;</span><span class="op">))</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>				transition<span class="op">(</span>edgeName <span class="op">=</span> <span class="st">&quot;t2&quot;</span><span class="op">,</span> targetState <span class="op">=</span> <span class="st">&quot;answareWithActual&quot;</span><span class="op">,</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>				cond <span class="op">=</span> whenRequest<span class="op">(</span><span class="st">&quot;readDistance&quot;</span><span class="op">))</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>			<span class="op">}</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>			</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>			state<span class="op">(</span><span class="st">&quot;readSonar&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>				action <span class="op">{</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>					prevDistance <span class="op">=</span> distance</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>					distance <span class="op">=</span> sonar<span class="op">.</span>read<span class="op">()</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>					<span class="cf">if</span><span class="op">(</span>prevDistance <span class="op">!=</span> distance<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>						emit<span class="op">(</span><span class="st">&quot;sonarDistance&quot;</span><span class="op">,</span> <span class="st">&quot;sonarDistance(</span><span class="ss">$distance</span><span class="st">)&quot;</span><span class="op">)</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>					<span class="op">}</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>				<span class="op">}</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>				transition<span class="op">(</span>edgeName <span class="op">=</span> <span class="st">&quot;t3&quot;</span><span class="op">,</span> targetState <span class="op">=</span> <span class="st">&quot;work&quot;</span><span class="op">,</span> cond <span class="op">=</span> doswitch<span class="op">())</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>			<span class="op">}</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>			</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>			state<span class="op">(</span><span class="st">&quot;answareWithActual&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>				action <span class="op">{</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>					replyToCaller<span class="op">(</span><span class="st">&quot;readDistance&quot;</span><span class="op">,</span> <span class="st">&quot;readDistance(</span><span class="ss">$distance</span><span class="st">)&quot;</span><span class="op">)</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>				<span class="op">}</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>				transition<span class="op">(</span>edgeName <span class="op">=</span> <span class="st">&quot;t4&quot;</span><span class="op">,</span> targetState <span class="op">=</span> <span class="st">&quot;work&quot;</span><span class="op">,</span> cond <span class="op">=</span> doswitch<span class="op">())</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>			<span class="op">}</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>		<span class="op">}</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>	<span class="op">}</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>	</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>	<span class="kw">override</span> <span class="kw">fun</span> <span class="fu">getInitialState</span><span class="op">():</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>		<span class="kw">return</span> <span class="st">&quot;begin&quot;</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>	<span class="op">}</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>	</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb8"
data-caption="\texttt{LedActor (\texttt{ledsonarsystem0})}"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="at">@QActor</span><span class="op">(</span><span class="st">&quot;ctxLedSonarAbFsmDemo&quot;</span><span class="op">)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LedActor<span class="op">(</span><span class="va">name</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">scope</span> <span class="op">:</span> <span class="dt">CoroutineScope</span><span class="op">)</span> <span class="op">:</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>	<span class="dt">ActorBasicFsm</span><span class="op">(</span><span class="va">name</span><span class="op">,</span> <span class="va">scope</span><span class="op">,</span> <span class="va">autoStart</span> <span class="op">=</span> false<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>	<span class="kw">val</span> <span class="va">led</span> <span class="op">=</span> SYSTEM_LED</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>	<span class="kw">override</span> <span class="kw">fun</span> <span class="fu">getBody</span><span class="op">():</span> <span class="dt">ActorBasicFsm</span><span class="op">.()</span> -&gt; <span class="fu">Unit</span> <span class="op">{</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>		<span class="kw">return</span> <span class="op">{</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>			</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>			state<span class="op">(</span><span class="st">&quot;begin&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>				action <span class="op">{}</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>				transition<span class="op">(</span>edgeName <span class="op">=</span> <span class="st">&quot;t0&quot;</span><span class="op">,</span> targetState <span class="op">=</span> <span class="st">&quot;work&quot;</span><span class="op">,</span> cond <span class="op">=</span> doswitch<span class="op">())</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>			<span class="op">}</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>			</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>			state<span class="op">(</span><span class="st">&quot;work&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>				action <span class="op">{}</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>				transition<span class="op">(</span>edgeName <span class="op">=</span> <span class="st">&quot;t1&quot;</span><span class="op">,</span> targetState <span class="op">=</span> <span class="st">&quot;handleLedCmd&quot;</span><span class="op">,</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>					cond <span class="op">=</span> whenDispatch<span class="op">(</span><span class="st">&quot;ledCmd&quot;</span><span class="op">))</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>			<span class="op">}</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>			</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>			state<span class="op">(</span><span class="st">&quot;handleLedCmd&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>				action <span class="op">{</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>					<span class="cf">try</span> <span class="op">{</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>						<span class="cf">if</span><span class="op">(</span>checkMsgContent<span class="op">(</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>							Term<span class="op">.</span>createTerm<span class="op">(</span><span class="st">&quot;ledCmd(CMD)&quot;</span><span class="op">),</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>							Term<span class="op">.</span>createTerm<span class="op">(</span><span class="st">&quot;ledCmd(CMD)&quot;</span><span class="op">),</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>							currentMsg<span class="op">.</span>msgContent<span class="op">()))</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>						<span class="cf">when</span><span class="op">(</span><span class="kw">val</span> <span class="va">ledCmdArg</span> <span class="op">=</span> payloadArg<span class="op">(</span><span class="dv">0</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>							<span class="st">&quot;OFF&quot;</span><span class="op">,</span> <span class="st">&quot;off&quot;</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>								<span class="cf">if</span><span class="op">(</span>led<span class="op">.</span>isPoweredOn<span class="op">())</span> <span class="op">{</span>led<span class="op">.</span>powerOff<span class="op">()}</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>							<span class="op">}</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>							<span class="st">&quot;ON&quot;</span><span class="op">,</span> <span class="st">&quot;on&quot;</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>								<span class="cf">if</span><span class="op">(</span>led<span class="op">.</span>isPoweredOff<span class="op">())</span> <span class="op">{</span>led<span class="op">.</span>powerOn<span class="op">()}</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>							<span class="op">}</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>						<span class="op">}</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>					<span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>e <span class="op">:</span> Exception<span class="op">)</span> <span class="op">{</span><span class="co">/* ... */</span><span class="op">}</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>				<span class="op">}</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>				transition<span class="op">(</span>edgeName <span class="op">=</span> <span class="st">&quot;t2&quot;</span><span class="op">,</span> targetState <span class="op">=</span> <span class="st">&quot;work&quot;</span><span class="op">,</span> cond <span class="op">=</span> doswitch<span class="op">())</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>			<span class="op">}</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>		<span class="op">}</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>	<span class="op">}</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>	<span class="kw">override</span> <span class="kw">fun</span> <span class="fu">getInitialState</span><span class="op">():</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>		<span class="kw">return</span> <span class="st">&quot;begin&quot;</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>	<span class="op">}</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>With some other classes that we have not reported here, the
description of the actors of the system is completed. But the system can
not be started yet because there are nothing able to make it run reading
the annotations. It is needed a component that <strong>scans all the
classes and load the annotated one</strong>. Indeed, we have developed a
new component called <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/annotations/AnnotationLoader.kt"><span
style="color: ForestGreen"><code>AnnotationLoader</code></span></a> with
the method</p>
<div class="center">
<table>
<tbody>
<tr class="odd">
<td style="text-align: center;"><div class="sourceCode" id="cb9"
data-frame="none" data-numbers="none" data-language="Kotlin"><pre
class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">loadSystemByAnnotations</span><span class="op">(</span><span class="va">params</span> <span class="op">:</span> <span class="dt">ReadableParameterMap</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>						<span class="op">=</span> immutableParameterMap<span class="op">())</span> <span class="op">:</span> <span class="dt">SystemBuilder</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>		</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>This method <strong>scan all classes of the application and search
for annotated</strong> loading them depending on the annotation. We have
also added a component called <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/QakLauncher.kt"><span
style="color: ForestGreen"><code>QakLauncher.kt</code></span></a> with
proper methods that launch the system calling the
<code>AnnotationLoader</code>. So the <code>Kotlin</code> script that
launches the system is:</p>
<div class="sourceCode" id="cb10"
data-caption="\texttt{App.kt} (\texttt{ledsonarsystem0})"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="at">@QakContext</span><span class="op">(</span><span class="st">&quot;ctxLedSonarAbFsmDemo&quot;</span><span class="op">,</span> <span class="st">&quot;localhost&quot;</span><span class="op">,</span> <span class="st">&quot;TCP&quot;</span><span class="op">,</span><span class="dv">9000</span><span class="op">)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="at">@HostName</span><span class="op">(</span><span class="st">&quot;localhost&quot;</span><span class="op">)</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ContextConfiguration</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> main<span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>	startLedSonarSystem<span class="op">()</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>	</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>	runBlocking <span class="op">{</span><span class="co">/*this:CoroutineScope*/</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>		launchQak<span class="op">(</span><span class="kw">this</span><span class="op">)</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>	<span class="op">}</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Notice that this mechanism is added to the infrastructure as an
extension and without invalidating the old <code>.pl</code>
definition.</p>
<h2 id="new-classes-for-injection">New classes for injection</h2>
<p>We remember that <a
href="https://github.com/anatali/issLab2021/blob/main/it.unibo.qakactor/src/main/kotlin/ActorBasic.kt">ActorBasic</a>
and <a
href="https://github.com/anatali/issLab2021/blob/main/it.unibo.qakactor/src/main/kotlin/ActorBasicFsm.kt">ActorBasicFsm</a>
classes are <em>abstract</em> so it is not possible to directly create
instances of this classes because of the <em>abstract</em> definition.
For this reason we have created the two classes shown in the previous
section and that are used from the builders:
<code>ActorBasicWrapper</code> and <code>ActorBasicFsmWrapper</code>
that takes the transient actor definitions and wrap them into
<code>ActorBasic</code> or <code>ActorBasicFsm</code> instances.</p>
<p>Now it is clear that a level of strong separation has been introduced
between the <span
style="color: ForestGreen"><strong><em>definition</em></strong></span>
of the actor system and the <span
style="color: ForestGreen"><strong><em>runnable
implementation</em></strong></span> of it.</p>
<p>In addition to this, the new <code>@QActor</code> annotation allows
the developer to specify the actor’s name directly into the proper
annotation field. So, if the developer is forced to directly extends the
<code>ActorBasic</code> class, he must always specify a constructor with
the two parameter needed by the superclass as done in the previous
listings.</p>
<p>We want not only to avoid this but also to introduce <strong>a new
stronger level of separation</strong> between the runnable part of the
actor (represented by the <code>ActorBasic</code> inherited type) and
the description (represented by the override of the proper methods).</p>
<figure>
<embed src="img/[UML]QActorBasic_QActorBasicFsm_Auto.pdf"
id="fig::q_autoq_classes" />
<figcaption aria-hidden="true"><code>Q</code> and <code>AutoQ</code>
classes</figcaption>
</figure>
<p>Then, first, we have created new classes in order to realize the
separation: <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/QActorBasic.kt"><code>QActorBasic</code></a>
and <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/QActorBasicFsm.kt"><code>QActorBasicFsm</code></a>.
These two classes are illustrated in the figure <a
href="#fig::q_autoq_classes" data-reference-type="ref"
data-reference="fig::q_autoq_classes">10</a> and can be used in order to
define the behaviour of the actors (<em>basic</em> or finite state
machine) by extending them and adding other mechanisms such as some
proper annotations that will be shown.</p>
<p>However, the application designer can decide to insert some
operations inside the behaviour that requires to be invoked on the
<em>runnable instance</em> of the actor he is developing. For this
reason, the <code>QActorBasic</code> must anyway maintain the
<em>runnable part</em> that is the <code>ActorBasic</code> instance (and
the correspondent <code>ActorBasicFsm</code> for the
<code>QActorBasicFsm</code>) that unfortunately should be available only
after the instantiation of the <code>Q</code> classes.</p>
<p>As shown in figure <a href="#fig::q_autoq_classes"
data-reference-type="ref" data-reference="fig::q_autoq_classes">10</a>,
the main operations that require the executable instance are related
with sending messages and events or performing <code>CoAP</code> updates
or <code>Mqtt</code> interactions.</p>
<p>The <code>QActorBasic</code> and <code>QActorBasicFsm</code> classes
are very useful in order to define new methods for describing the
behaviour of the actors, but they do not provide a full and complete
mechanism for this. What the developer needs to put inside these
classes? And above all, how it is possible to initialize the
<code>ActorBasic</code> variable inside?</p>
<p>We will answer to the first question in the next subsection. Indeed,
for the second, we can say that the most easy and useful way to put the
<code>ActorBasic</code> instance is by using reflection. So, the
application designer writes the code to create an actor using
<code>QActorBasic</code> and then the component able to load the class
instantiates the related <code>ActorBasic</code> instance and inject it
to the <code>Q</code> class.</p>
<h2 id="autoq-classes-ledonarsystem1"><code>AutoQ</code> classes [ <a
href="https://github.com/LM-96/QA-Extensions/tree/main/it.unibo.ledsonardemo1"><span
style="color: Emerald"><strong>ledonarsystem1</strong></span></a> ]</h2>
<p>In the figure <a href="#fig::q_autoq_classes"
data-reference-type="ref" data-reference="fig::q_autoq_classes">10</a>
are present two new classes that we have not clarified: <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/AutoQActorBasic.kt"><code>AutoQActorBasic</code></a>
and <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/AutoQActorBasicFsm.kt"><code>AutoQActorBasicFsm</code></a>.
They are very simple because their only work is to let the application
designer to use the <em>legacy</em> actor definition with the
<em>descriptive annotation</em> without forcing him to use the classical
constructor of the <code>ActorBasic</code> or <code>ActorBasicFsm</code>
classes.</p>
<p>So, <span style="color: ForestGreen"><strong>it is possible to use
the <code>@QActor</code> annotation with a class that extends
<code>AutoQActorBasic</code></strong></span> without specifying any
parameter in the superclass constructor (and in this sense it is
<em>auto</em>).</p>
<p>For example, consider the <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.ledsonardemo1/src/main/kotlin/it/unibo/ledsonardemo1/actors/SonarActor.kt"><code>SonarActor</code></a>
in the <a
href="https://github.com/LM-96/QA-Extensions/tree/main/it.unibo.ledsonardemo1"><span
style="color: Emerald"><strong>ledonarsystem1</strong></span></a>. With
these new classes the code becomes:</p>
<div class="sourceCode" id="cb11"
data-caption="\texttt{SonarActor} (\texttt{ledsonarsystem1})"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="at">@QActor</span><span class="op">(</span><span class="st">&quot;ctxLedSonarAutoQAbFsmDemo&quot;</span><span class="op">)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>	<span class="kw">class</span> SonarActor <span class="op">:</span> <span class="dt">AutoQActorBasicFsm</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>		<span class="co">/* ... [same definition od variables of ledsonarsystem0] ... */</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>		<span class="kw">override</span> <span class="kw">fun</span> <span class="fu">getBody</span><span class="op">():</span> <span class="dt">ActorBasicFsm</span><span class="op">.()</span> -&gt; <span class="fu">Unit</span> <span class="op">{</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>			<span class="co">/* ... [ same code of ledsonarsystem0 ] ... */</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>		<span class="op">}</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>		<span class="kw">override</span> <span class="kw">fun</span> <span class="fu">getInitialState</span><span class="op">():</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>			<span class="co">/* ... [ same code of ledsonarsystem0 ] ... */</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>		<span class="op">}</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>	<span class="op">}</span></span></code></pre></div>
<p>As we can see there are no <code>name : String</code> and
<code>scope : CoroutineScope</code> parameters in the constructor like
the previous version. Nothing else to say about these two classes.</p>
<h2 id="behavioural-annotations-ledonarsystem2">Behavioural annotations
[ <a
href="https://github.com/LM-96/QA-Extensions/tree/main/it.unibo.ledsonardemo2"><span
style="color: Emerald"><strong>ledonarsystem2</strong></span></a> ]</h2>
<p>At this point we have some annotations the developer can use to
describe and <em>identify</em> actors and contexts in the system instead
of using the old <code>.pl</code> files. In addition to this, we have
provided the new classes <code>QActorBasic</code> and
<code>QActorBasicFsm</code> that open the way to new mechanisms to
define the behaviour.</p>
<p>Indeed, we have created new annotations that can be used in
<code>QActorBasic</code> and <code>QActorBasicFsm</code>:</p>
<ul>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/annotations/ActorBody.kt"><span
style="color: YellowOrange"><u><code>ActorBody</code></u></span></a>:<br />
<em>This annotation is applicable to a method of a class that extends
<code>QActorBasic</code> and represents the classical body of
<code>ActorBasic</code>. <strong>The signature of the marked method must
be the same of the <code>ActorBasic#actorBody()</code>, so it must
return <code>Unit</code> and take one and only one
<code>IApplMessage</code> input parameter.</strong></em></p>
<div class="sourceCode" id="cb12" data-numbers="none"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>annotation <span class="kw">class</span> ActorBody<span class="op">()</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>	</span></code></pre></div></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/annotations/State.kt"><span
style="color: YellowOrange"><u><code>State</code></u></span></a>:<br />
<em>This annotation is applicable to a method of a class that extends
<code>QActorBasicFsm</code> and represents a state with a name and a
body that is the method that is marked. The name can also be not present
and in this case it is taken from the name of the method the annotation
is marking. <strong>The marked method must has no input parameter while
the return type is ignored</strong>.</em></p>
<div class="sourceCode" id="cb13" data-numbers="none"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>annotation <span class="kw">class</span> State<span class="op">(</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">name</span> <span class="op">:</span> <span class="dt">String</span> <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>		<span class="op">)</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>	</span></code></pre></div></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/annotations/State.kt"><span
style="color: YellowOrange"><u><code>Initial</code></u></span></a>:<br />
<em>This simple annotation is applicable to a method of a class that
extends <code>QActorBasicFsm</code> and marks the state that is the
initial for a finite state actor.</em></p>
<div class="sourceCode" id="cb14" data-numbers="none"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>annotation <span class="kw">class</span> Initial<span class="op">()</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>	</span></code></pre></div></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/annotations/Transitions.kt">
<span
style="color: YellowOrange"><u><code>EpsilonMove</code></u></span>,
<span
style="color: YellowOrange"><u><code>WhenDispatch</code></u></span>,
<span style="color: YellowOrange"><u><code>WhenReply</code></u></span>,
<span style="color: YellowOrange"><u><code>WhenEvent</code></u></span>,
<span
style="color: YellowOrange"><u><code>WhenInvitation</code></u></span>,
<span
style="color: YellowOrange"><u><code>WhenTime</code></u></span></a>:<br />
<em>This group of annotations represents the transitions that can be
performed by a finite state machine after the execution of the body of a
state. So, <strong>all of these annotations have sense if put to a
method that has the <code>@State</code> annotation</strong> and define
the transition to be <em>invoked</em> after the referred state body is
executed. Notice that these annotations are <a
href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.annotation/-repeatable/"><code>Repeatable</code></a>
so it is possible to link more than one transition of the same type to
the same state (particularly useful for <em>guarded</em> transitions).
All of them has an <code>edgeName</code> and a <code>targetState</code>
and others parameters based on the type of the transition.</em></p>
<div class="sourceCode" id="cb15" data-numbers="none"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>annotation <span class="kw">class</span> EpsilonMove<span class="op">(</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">edgeName</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">targetState</span> <span class="op">:</span> <span class="dt">String</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>		<span class="op">)</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>		annotation <span class="kw">class</span> WhenDispatch<span class="op">(</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">edgeName</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">targetState</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">messageName</span> <span class="op">:</span> <span class="dt">String</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>		<span class="op">)</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>		annotation <span class="kw">class</span> WhenRequest<span class="op">(</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">edgeName</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">targetState</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">messageName</span> <span class="op">:</span> <span class="dt">String</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>		<span class="op">)</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>		annotation <span class="kw">class</span> WhenReply<span class="op">(</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">edgeName</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">targetState</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">messageName</span> <span class="op">:</span> <span class="dt">String</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>		<span class="op">)</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>		annotation <span class="kw">class</span> WhenInvitation<span class="op">(</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">edgeName</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">targetState</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">messageName</span> <span class="op">:</span> <span class="dt">String</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>		<span class="op">)</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>		annotation <span class="kw">class</span> WhenEvent<span class="op">(</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">edgeName</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">targetState</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">eventName</span> <span class="op">:</span> <span class="dt">String</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>		<span class="op">)</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>		annotation <span class="kw">class</span> WhenTime<span class="op">(</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">edgeName</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">targetState</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">millis</span> <span class="op">:</span> <span class="dt">Long</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>		<span class="op">)</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>	</span></code></pre></div></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/annotations/Transitions.kt"><span
style="color: YellowOrange"><u><code>GuardFor</code></u></span></a>:<br />
<em>This simple annotation is applicable to a method of a class that
extends <code>QActorBasicFsm</code> and marks a method that is the
<em>guard</em> for an existing transition. <strong>The method marked
with this annotation must imperatively have no input parameters and
return a <code>Boolean</code></strong> that is <code>true</code> if the
referred transition has to be performed depending on the guard or
<code>false</code> otherwise. The association between the guard and the
transition is made by the <code>transitionEdgeName</code> parameter of
this annotation and the state to reach if the guard is
<code>false</code> is maintained by the <code>elseTarget</code> variable
that can be empty if no state has to be reached.</em></p>
<div class="sourceCode" id="cb16" data-numbers="none"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>annotation <span class="kw">class</span> GuardFor<span class="op">(</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>		<span class="kw">val</span> <span class="va">transitionEdgeName</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>		<span class="kw">val</span> <span class="va">elseTarget</span> <span class="op">:</span> <span class="dt">String</span> <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>	<span class="op">)</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>	</span></code></pre></div></li>
</ul>
<p>So the <code>AnnotationLoader</code> has been extended in order to
support these new annotations letting the software developer to use them
in order to define not only the actors and the contexts that are present
but also their behaviour, their states and their actions.</p>
<p>The <a
href="https://github.com/LM-96/QA-Extensions/tree/main/it.unibo.ledsonardemo2"><span
style="color: Emerald"><strong>ledonarsystem2</strong></span></a>
example shows how it is possible to use these new annotations. In this
paper we just show the <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.ledsonardemo0/src/main/kotlin/it/unibo/ledsonardemo2/actors/SonarActor.kt">SonarActor</a>
and the <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.ledsonardemo0/src/main/kotlin/it/unibo/ledsonardemo2/actors/LedActor.kt">LedActor</a>
as previously done:</p>
<div class="sourceCode" id="cb17"
data-caption="\texttt{SonarActor} (\texttt{ledsonarsystem2})"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="at">@QActor</span><span class="op">(</span><span class="st">&quot;ctxLedSonarQAbFsmDemo&quot;</span><span class="op">)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>	<span class="kw">class</span> SonarActor <span class="op">:</span> <span class="dt">QActorBasicFsm</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>		<span class="kw">var</span> <span class="va">distance</span> <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>		<span class="kw">var</span> <span class="va">prevDistance</span> <span class="op">=</span> distance</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>		<span class="kw">val</span> <span class="va">sonar</span> <span class="op">=</span> SYSTEM_SONAR</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>		<span class="at">@Initial</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>		<span class="at">@State</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>		<span class="at">@EpsilonMove</span><span class="op">(</span><span class="st">&quot;t0&quot;</span><span class="op">,</span> <span class="st">&quot;work&quot;</span><span class="op">)</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>		suspend <span class="kw">fun</span> <span class="fu">begin</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>		<span class="op">}</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>		<span class="at">@State</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>		<span class="at">@WhenTime</span><span class="op">(</span><span class="st">&quot;t1&quot;</span><span class="op">,</span> <span class="st">&quot;readSonar&quot;</span><span class="op">,</span> <span class="dv">2000</span><span class="op">)</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>		<span class="at">@WhenRequest</span><span class="op">(</span><span class="st">&quot;t2&quot;</span><span class="op">,</span> <span class="st">&quot;answareWithActual&quot;</span><span class="op">,</span> <span class="st">&quot;readDistance&quot;</span><span class="op">)</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>		suspend <span class="kw">fun</span> <span class="fu">work</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>		<span class="op">}</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>		<span class="at">@State</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>		<span class="at">@EpsilonMove</span><span class="op">(</span><span class="st">&quot;t2&quot;</span><span class="op">,</span> <span class="st">&quot;work&quot;</span><span class="op">)</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>		suspend <span class="kw">fun</span> <span class="fu">readSonar</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>			prevDistance <span class="op">=</span> distance</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>			distance <span class="op">=</span> sonar<span class="op">.</span>read<span class="op">()</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>			<span class="cf">if</span><span class="op">(</span>prevDistance <span class="op">!=</span> distance<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>				emit<span class="op">(</span><span class="st">&quot;sonarDistance&quot;</span><span class="op">,</span> <span class="st">&quot;sonarDistance(</span><span class="ss">$distance</span><span class="st">)&quot;</span><span class="op">)</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>			<span class="op">}</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>		<span class="op">}</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>		<span class="at">@State</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>		<span class="at">@EpsilonMove</span><span class="op">(</span><span class="st">&quot;t3&quot;</span><span class="op">,</span> <span class="st">&quot;work&quot;</span><span class="op">)</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>		suspend <span class="kw">fun</span> <span class="fu">answareWithActual</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>			answer<span class="op">(</span><span class="st">&quot;readDistance&quot;</span><span class="op">,</span> <span class="st">&quot;readedDistance&quot;</span><span class="op">,</span> <span class="st">&quot;readedDistance(</span><span class="ss">$distance</span><span class="st">)&quot;</span><span class="op">)</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>		<span class="op">}</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>	<span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb18"
data-caption="\texttt{LedActor (\texttt{ledsonarsystem2})}"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="at">@QActor</span><span class="op">(</span><span class="st">&quot;ctxLedSonarQAbFsmDemo&quot;</span><span class="op">)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>	<span class="kw">class</span> LedActor <span class="op">:</span> <span class="dt">QActorBasicFsm</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>		<span class="kw">val</span> <span class="va">led</span> <span class="op">=</span> SYSTEM_LED</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>		<span class="at">@Initial</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>		<span class="at">@State</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>		<span class="at">@EpsilonMove</span><span class="op">(</span><span class="st">&quot;t0&quot;</span><span class="op">,</span> <span class="st">&quot;work&quot;</span><span class="op">)</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>		suspend <span class="kw">fun</span> <span class="fu">begin</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>		<span class="op">}</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>		<span class="at">@State</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>		<span class="at">@WhenDispatch</span><span class="op">(</span><span class="st">&quot;t1&quot;</span><span class="op">,</span> <span class="st">&quot;handleLedCmd&quot;</span><span class="op">,</span> <span class="st">&quot;ledCmd&quot;</span><span class="op">)</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>		suspend <span class="kw">fun</span> <span class="fu">work</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>		<span class="op">}</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>		<span class="at">@State</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>		<span class="at">@EpsilonMove</span><span class="op">(</span><span class="st">&quot;t2&quot;</span><span class="op">,</span> <span class="st">&quot;work&quot;</span><span class="op">)</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>		suspend <span class="kw">fun</span> <span class="fu">handleLedCmd</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>			actorPrintln<span class="op">(</span><span class="st">&quot;Current command: </span><span class="ss">$currentMsg</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>			<span class="cf">try</span> <span class="op">{</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>				<span class="cf">when</span><span class="op">(</span><span class="kw">val</span> <span class="va">ledCmdArg</span> <span class="op">=</span> currentMessageArgs<span class="op">[</span><span class="dv">0</span><span class="op">])</span> <span class="op">{</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>					<span class="st">&quot;OFF&quot;</span><span class="op">,</span> <span class="st">&quot;off&quot;</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>						<span class="cf">if</span><span class="op">(</span>led<span class="op">.</span>isPoweredOn<span class="op">())</span> <span class="op">{</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>							led<span class="op">.</span>powerOff<span class="op">()</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>							actorPrintln<span class="op">(</span><span class="st">&quot;Led powered off&quot;</span><span class="op">)</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>						<span class="op">}</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>					<span class="op">}</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>					<span class="st">&quot;ON&quot;</span><span class="op">,</span> <span class="st">&quot;on&quot;</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>						<span class="cf">if</span><span class="op">(</span>led<span class="op">.</span>isPoweredOff<span class="op">())</span> <span class="op">{</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>							led<span class="op">.</span>powerOn<span class="op">()</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>							actorPrintln<span class="op">(</span><span class="st">&quot;Led powered on&quot;</span><span class="op">)</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>						<span class="op">}</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>					<span class="op">}</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>					<span class="cf">else</span> <span class="op">-&gt;</span> <span class="op">{}</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>				<span class="op">}</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>			<span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>e <span class="op">:</span> Exception<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>				e<span class="op">.</span>printStackTrace<span class="op">()</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>			<span class="op">}</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>		<span class="op">}</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>	<span class="op">}</span></span></code></pre></div>
<p>Notice that nothing has changed in the <code>App.kt</code> file but
simply the <code>AnnotationLoader</code> has been extended as we already
said.</p>
<h2 id="infix-functions">Infix Functions</h2>
<p><code>Kotlin</code> let the developer to write functions with the <a
href="https://kotlinlang.org/docs/functions.html#infix-notation"><strong>infix
notation</strong></a>.</p>
<p>Thanks to this possibility we can make the code smarter defining some
infix function for sending messages, emitting events and updating
<code>CoAP</code> states. For more details about that, see the
implementations of <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/QActorBasic.kt"><code>QActorBasic</code></a>
and <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/QActorBasicFsm.kt"><code>QActorBasicFsm</code></a>
classes.</p>
<p>We only show some <em>smart</em> way to do these operations:</p>
<div class="sourceCode" id="cb19" data-language="kotlin"
data-morekeywords="emit, event, withArgs, send, dispatch, request, replyTo, with, update, resource, arg"><pre
class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Emits the event &quot;eventName(arg0,arg1,arg2)&quot; */</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>	emit event <span class="st">&quot;eventName&quot;</span> withArgs <span class="st">&quot;arg0,arg1,arg2&quot;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>	</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>	<span class="co">/* Emits the event &quot;eventName(arg0,arg1,arg2)&quot; (smart syntax for args)</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">	   This syntax can be use with all &#39;withArg&#39; keywords	*/</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>	emit event <span class="st">&quot;eventName&quot;</span> withArgs arg <span class="op">[</span><span class="st">&quot;arg0&quot;</span><span class="op">,</span> <span class="st">&quot;arg1&quot;</span><span class="op">,</span> <span class="st">&quot;arg2&quot;</span><span class="op">]</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>	</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>	<span class="co">/* Sends the dispatch &quot;dispatchName(arg0,arg1)&quot; to &quot;destActor&quot; */</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>	send dispatch <span class="st">&quot;dispatchName&quot;</span> to <span class="st">&quot;destActor&quot;</span> withArgs <span class="st">&quot;arg0,arg1&quot;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>	</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>	<span class="co">/* Sends the request &quot;requestName(arg0,arg1,arg2,arg3)&quot; to &quot;destActor&quot; */</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>	send request <span class="st">&quot;requestName&quot;</span> to <span class="st">&quot;destActor&quot;</span> withArgs <span class="st">&quot;arg0,arg1,arg2,arg3&quot;</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>	</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>	<span class="co">/* Answers to request &quot;requestName&quot; with the reply &quot;replyName(arg0)&quot; */</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>	replyTo request <span class="st">&quot;requestName&quot;</span> with <span class="st">&quot;replyName&quot;</span> withArgs <span class="st">&quot;arg0&quot;</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>	</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>	<span class="co">/* Updates the CoAP resource */</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>	update resource <span class="st">&quot;new coap update&quot;</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>	</span></code></pre></div>
<p>We underline that are present two types of primitives for the
argument of messages:</p>
<ul>
<li><p>by using <strong><code>withArgs</code></strong> keyword that adds
the arguments to the message using the same syntax of the classical
<code>QAK</code> DSL;</p></li>
<li><p>by using <strong><code>withContext</code></strong> keyword that
directly put the raw contents into the message.</p></li>
</ul>
<h1 id="conclusions">Conclusions</h1>
<p>By summarizing, we started our work by <strong>defining</strong>
passive entities that only describe all the components of an actor based
system (in terms of contexts, actors, states and transitions). After, we
said that we used the <em>builder pattern</em> in order to create these
entities. Then, the builders can be used from others component in order
to load the system with a certain mechanism and after wrap them into
<code>ActorBasic</code> instances thanks to some <em>wrappers</em>. The
mechanism we have presented is based on <strong>annotations</strong>,
and we have shown all those available.</p>
<p>Now, the application designer can use three ways to define his own
actor system:</p>
<ol>
<li><p><strong>using only the <em>descriptive annotations</em></strong>
with the legacy <code>ActorBasic</code> and <code>ActorBasicFsm</code>
classes [<a
href="https://github.com/LM-96/QA-Extensions/tree/main/it.unibo.ledsonardemo0"><span
style="color: Emerald"><strong>ledonarsystem0</strong></span></a>]</p></li>
<li><p><strong>using only the <em>descriptive annotations</em></strong>
with the new <code>AutoQActorBasic</code> and
<code>AutoQActorBasicFsm</code> classes that let to use the empty
constructor [<a
href="https://github.com/LM-96/QA-Extensions/tree/main/it.unibo.ledsonardemo1"><span
style="color: Emerald"><strong>ledonarsystem1</strong></span></a>]</p></li>
<li><p><strong>using the full annotation support (<em>descriptive</em>
and <em>behavioural</em>)</strong> with the new <code>QActorBasic</code>
and <code>QActorBasicFsm</code> classes [<a
href="https://github.com/LM-96/QA-Extensions/tree/main/it.unibo.ledsonardemo2"><span
style="color: Emerald"><strong>ledonarsystem2</strong></span></a>]</p></li>
</ol>
<p>Surely, the third mechanism is the most effective and practical with
the smartest code even if it has not the same <em>language support</em>
of the original <code>DSL</code>. However, it has the great advantage
<strong>to be completely independent of any IDE</strong> or third-party
tools because the annotations are directly supported from
<code>Java</code> and <code>Kotlin</code>.</p>
<h1 id="additional-annotations">Additional annotations</h1>
<p>In addition to the <em>descriptive annotations</em> that have already
been presented, we develop some other annotations in order to configure
the system for <em>logging</em> or <code>Mqtt</code>:</p>
<ul>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/annotations/MqttBroker.kt"><span
style="color: YellowOrange"><u><code>MqttBroker</code></u></span></a>:<br />
<em>This annotation is applicable to a class (preferably the same of the
<code>@QakContext</code> annotation) and specify the
<code>Mqtt Broker</code> of the system like the original
<code>DSL</code>.</em></p>
<div class="sourceCode" id="cb20" data-numbers="none"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>annotation <span class="kw">class</span> MqttBroker<span class="op">(</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">address</span> <span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">port</span> <span class="op">:</span> <span class="dt">Int</span><span class="op">,</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">topic</span> <span class="op">:</span> <span class="dt">String</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>		<span class="op">)</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>	</span></code></pre></div></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/annotations/Tracing.kt"><span
style="color: YellowOrange"><u><code>Tracing</code></u></span></a>:<br />
<em>This annotation is applicable to a class (preferably the same of the
<code>@QakContext</code> annotation) and enable the <code>trace</code>
option of the legacy <code>DSL</code>.</em></p>
<div class="sourceCode" id="cb21" data-numbers="none"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>annotation <span class="kw">class</span> Tracing<span class="op">(</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">active</span> <span class="op">:</span> <span class="dt">Boolean</span> <span class="op">=</span> true</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>		<span class="op">)</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>	</span></code></pre></div></li>
<li><p><a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/annotations/Msglogging.kt"><span
style="color: YellowOrange"><u><code>MsgLogging</code></u></span></a>:<br />
<em>This annotation is applicable to a class (preferably the same of the
<code>@QakContext</code> annotation) and enable the
<code>msglogging</code> option of the legacy <code>DSL</code>.</em></p>
<div class="sourceCode" id="cb22" data-numbers="none"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>annotation <span class="kw">class</span> Msglogging<span class="op">(</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>			<span class="kw">val</span> <span class="va">active</span> <span class="op">:</span> <span class="dt">Boolean</span> <span class="op">=</span> true</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>		<span class="op">)</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>	</span></code></pre></div></li>
</ul>
<h1 id="invocation-of-suspend-methods">Invocation of
<code>suspend</code> methods</h1>
<p>As we said, in the methods marked with <code>@State</code>
annotation, the application designer can call some methods like
<code>emit(...)</code>, <code>send(...)</code> or
<code>answer(...)</code> but according to the <code>QAK</code>
specifications these operations are <a
href="https://kotlinlang.org/docs/coroutines-basics.html#extract-function-refactoring"><code>suspend fun</code></a>.</p>
<p>So, when the <code>AnnotationLoader</code> load all the classes
marked with <code>@Actor</code>, it has to consider that some <em>state
methods</em> can be suspendable, so they must be called from a <a
href="https://kotlinlang.org/docs/coroutines-guide.html"><code>Coroutine</code></a>.
For this reason, we have developed <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/utils/MethodUtils.kt"><code>MethodUtils.kt</code></a>,
a small <code>.kt</code> file with some utility methods, in particular
we have the function:</p>
<div class="center">
<table>
<tbody>
<tr class="odd">
<td style="text-align: center;"><div class="sourceCode" id="cb23"
data-frame="none" data-numbers="none" data-language="Kotlin"><pre
class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>suspend <span class="kw">fun</span> <span class="fu">Method</span><span class="op">.</span><span class="fu">invokeSuspend</span><span class="op">(</span><span class="va">obj</span> <span class="op">:</span> <span class="dt">Any</span><span class="op">,</span> <span class="kw">vararg</span> <span class="va">param</span> <span class="op">:</span> <span class="dt">Any</span><span class="op">?)</span> <span class="op">:</span> <span class="dt">Any</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>		</span></code></pre></div></td>
</tr>
</tbody>
</table>
</div>
<p>This method uses the <a
href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines.intrinsics/suspend-coroutine-unintercepted-or-return.html"><code>suspendCoroutineUninterceptedOrReturn</code></a>
built-in function that obtains the current coroutine <a
href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/-continuation/"><code>Continuation</code></a>
and call the <code>block</code> passed as parameter inside this
continuation. Summarizing, the <a
href="https://kotlinlang.org/docs/extensions.html">extension
function</a> <code>invokeSuspend</code> we have defined is able to
obtain the current continuation and invoke the method using the instance
which calls the function by using reflection.</p>
<p>Let us make a simple example (see <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/demo/InvokeSuspendDemo.kt"><code>InvokeSuspendDemo.kt</code></a>):</p>
<div class="sourceCode" id="cb24"
data-caption="Example for \texttt{invokeSuspend}"
data-language="Kotlin"><pre class="sourceCode Kotlin"><code class="sourceCode kotlin"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ExampleClazz<span class="op">(</span><span class="kw">val</span> <span class="va">exampleName</span> <span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>		</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>		suspend <span class="kw">fun</span> <span class="fu">suspendWelcome</span><span class="op">(</span><span class="va">name</span> <span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>			println<span class="op">(</span><span class="st">&quot;[</span><span class="ss">${</span>exampleName<span class="ss">}</span><span class="st">] Welcome from suspend </span><span class="ss">$name</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>		<span class="op">}</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>	<span class="op">}</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>	</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>	<span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span> <span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>		<span class="kw">val</span> <span class="va">suspendWelcomeMethod</span> <span class="op">=</span> ExampleClazz<span class="op">::</span><span class="kw">class</span>.java.methods</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>		.find <span class="op">{</span> it<span class="op">.</span>name <span class="op">==</span> <span class="st">&quot;suspendWelcome&quot;</span> <span class="op">}</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>		<span class="kw">val</span> <span class="va">exampleInst</span> <span class="op">=</span> ExampleClazz<span class="op">(</span><span class="st">&quot;EXAMPLE NAME&quot;</span><span class="op">)</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>		runBlocking <span class="op">{</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>			suspendWelcomeMethod<span class="op">?.</span>invokeSuspend<span class="op">(</span>exampleInst<span class="op">,</span> <span class="st">&quot;main&quot;</span><span class="op">)</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>		<span class="op">}</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>	<span class="op">}</span></span></code></pre></div>
<p>The example shows how it is possible to use our
<code>invokeSuspend</code> function in order to invoke a method using an
instance of <a
href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Method.html"><code>Method</code></a>
class (by reflection).</p>
<p>Notice that <span style="color: BrickRed"><strong>at the moment a
method marked with <code>@State</code> annotation must be
<code>suspend</code></strong></span>. This is a <em>small</em>
limitation because the developer is forced to make all <em>state
methods</em> <code>suspend</code>, but it is not a problem and in future
developments this mechanism can be improved very rapidly.</p>
<h1 id="suspendable-actors">Suspendable actors</h1>
<p>In addition to our work, we also want to resolve a small problem that
is: how to <em>pause</em> an actor? And what does <em>paused</em> means
for an actor?</p>
<p><span style="color: ForestGreen"><strong>When an actor receives a
<em>pause</em> command in a certain <span
class="math inline"><em>S</em><sub><em>x</em></sub></span> state, from
this moment it will not handle any message until receives the
<em>resume</em> command, then it regularly returns to <span
class="math inline"><em>S</em><sub><em>x</em></sub></span> state at the
same conditions it was before pausing</strong></span>.</p>
<p>So, what appends to the messages that are received while the actor is
paused? There are two possibilities:</p>
<ol>
<li><p>the messages are <strong>ignored</strong> and discarded;</p></li>
<li><p>the messages are <strong>restored</strong> and handled by the
actor when it receives the <code>resume</code> command.</p></li>
</ol>
<p>Obviously, the <code>pause</code> and <code>resume</code> command are
<strong>messages</strong> with a dedicated and fixed id. We choose to
use <code>sys_suspend_actor</code> and <code>sys_resume_actor</code> as
the ids for <code>pause</code> and <code>resume</code>. We also decide
to let the application designer to choose how to manage the messages
while an actor is in pause.</p>
<figure>
<embed src="img/[UML]Suspendable.pdf" id="fig::suspendable" />
<figcaption aria-hidden="true">Suspendable classes</figcaption>
</figure>
<p>The figure <a href="#fig::suspendable" data-reference-type="ref"
data-reference="fig::suspendable">11</a> shows the components for the
suspension mechanism. The main classes are <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/SuspendableActorBasic.kt"><code>SuspendableActorBasic</code></a>
and <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/SuspendableActorBasicFsm.kt"><code>SuspendableActorBasicFsm</code></a>
and their names suggest their use.</p>
<p>Please notice the class <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/SuspendableCore.kt"><code>SuspendableCore</code></a>
that is developed in order to make the code very reusable and to limit
code repetitions. In addition to all of these classes we also provide <a
href="https://github.com/LM-96/QA-Extensions/blob/main/it.unibo.qakactor/src/main/kotlin/demo/EchoSuspendableActor.kt"><code>EchoSuspendableActor</code></a>
that show some examples of this pausing mechanism.</p>
<p>Without going deeply into details, we can say that this mechanism is
based on the <code>actorBody</code> function of the
<code>ActorBasic</code> class that is extended by
<code>SuspendableActorBasic</code> and
<code>SuspendableActorBasicFsm</code>. As you can see in the source
code, the overriding methods call the function
<code>handleMessage</code> defined into <code>SuspendableCore</code>
that is able to decide to handle the message if not pausing or to do
something else if the actor is in pause mode. Then, the
<code>handleMessage</code> is a sort of <em>filter</em> that decides if
the message has to be handled.</p>
<p>So, in order to define actors with the ability to go into suspension,
the application designer must extend <code>SuspendableActorBasic</code>
implementing <code>onMessageWhenNotSuspended</code> or
<code>SuspendableActorBasicFsm</code> with the normal procedure used
also for <code>ActorBasicFsm</code>. All the job is done by the already
implemented <code>actorBody</code> function.</p>
<p>In order to decide if the messages have to be saved into a buffer and
restored when resumed or to be discarded, the developer can pass a
proper boolean inside the constructor of the suspendable actor classes.
If the messages are stored into a buffer, when the actor receives the
<code>resume</code> command, then all the saved messages are restored
<strong>in order</strong> and the actor pass into a <em>meta-state</em>
that is called <code>RESUMING</code> (see the
<code>SuspensionState</code> enumeration). After all messages have been
restored, the actor returns at the normal work in the state it was
before the suspension.</p>
<p>Notice that as anticipated, we have added a new <em>layer of
state</em> to the actors that concerns only the <em>suspension state of
the actor</em> and that is defined by the <code>SuspensionState</code>
enumeration. This kind of state of a <code>SuspendableActorBasic</code>
(or <code>SuspendableActorBasicFsm</code>) is observable thanks to the
new <a
href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-state-flow/"><code>Kotlin StateFlow</code></a>
that can be obtained from the owned <code>SuspendableCore</code> of
these actors.</p>
<p><span style="color: ForestGreen"><strong>If a suspendable actor is
resuming, then also the messages that arrives in this state are enqueued
into the buffer. In addition to this, please notice that a finite state
machine actor does not really change his <em>fsm</em> state during the
pause, but it is not able to have the normal work because it is locked
by the <code>SuspendableCore</code>.</strong></span></p>
<p>In future development, it is easy to add a new annotation like
<code>@Suspendable</code> that marks an actor that can be suspended. It
is only required to add the proper support for this kind of annotation
to the <code>AnnotationLoader</code> that can inject a
<code>SuspendableActorBasic</code>(<code>Fsm</code>) to a
<code>QActorBasic</code> instance.</p>
<section class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>See the documentation for more
details.<a href="#fnref1" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>See the official <code>QAK</code>
documentations for details about the creation of a finite state machine
actor.<a href="#fnref2" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
